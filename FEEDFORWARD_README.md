# 速度环前馈控制使用说明

## 📖 概述

本项目已为M2006电机速度环添加了**前馈控制**功能，可显著提高系统的响应速度和跟踪性能。

前馈控制（Feedforward Control）是一种开环控制策略，它根据目标值直接计算所需的控制输出，而不依赖反馈误差。结合传统的PID反馈控制，可以获得更好的控制效果。

---

## 🎯 前馈控制原理

### 传统PID控制器输出：
```
output = Kp × error + Ki × ∫error·dt + Kd × derror/dt
```

### 增强型PID（带前馈）输出：
```
output = Kp × error + Ki × ∫error·dt + Kd × derror/dt + Kff × target + Kaff × dtarget/dt
                                                          ↑               ↑
                                                    速度前馈        加速度前馈
```

---

## 🔧 前馈项说明

### 1️⃣ 速度前馈 (Kff)

**作用**：根据目标速度直接给出基础电流输出

**物理意义**：
- 克服恒定的摩擦力和负载力矩
- 补偿电机反电动势
- 减少稳态误差

**参数范围**：
- **建议值**：0.5 ~ 2.0 mA/RPM
- **初始值**：0.8 mA/RPM（已在代码中设置）

**调整原则**：
- Kff **过小**：响应慢，需要PID积分项补偿，稳态误差大
- Kff **过大**：可能超调，稳态时输出偏大
- Kff **合适**：快速响应，稳态误差小

---

### 2️⃣ 加速度前馈 (Kaff)

**作用**：根据目标速度的变化率（加速度）补偿惯性力矩

**物理意义**：
- 补偿电机转子和负载的转动惯量
- 在快速启停时减少跟踪误差
- 改善动态响应

**参数范围**：
- **建议值**：0.0 ~ 0.5 mA/(RPM/s)
- **初始值**：0.1 mA/(RPM/s)（已在代码中设置）

**调整原则**：
- Kaff = 0：不使用加速度前馈（推荐先调好速度前馈再调加速度前馈）
- Kaff **过小**：启动和变速时响应慢
- Kaff **过大**：启动时可能冲击过大，引起振荡

---

## 📝 使用方法

### 方法1️⃣：使用默认参数（推荐新手）

默认参数已在 `m2006_motor.c` 的 `M2006_InitAll()` 函数中设置：
- Kff = 0.8 mA/RPM
- Kaff = 0.1 mA/(RPM/s)

**无需额外代码**，初始化后自动生效。

```c
M2006_InitAll(motors, &hcan1);  // 自动设置默认前馈参数
```

---

### 方法2️⃣：运行时动态调整

在 `main.c` 的初始化部分（或运行过程中）调用 `M2006_SetFeedforward()` 函数：

```c
// 在 main() 函数中，M2006_InitAll() 之后
M2006_InitAll(motors, &hcan1);

// 为电机1设置自定义前馈参数
M2006_SetFeedforward(&motors[0], 1.2f, 0.15f);  // Kff=1.2, Kaff=0.15

// 为电机2设置不同的参数
M2006_SetFeedforward(&motors[1], 0.6f, 0.05f);  // Kff=0.6, Kaff=0.05
```

---

### 方法3️⃣：禁用前馈（仅使用传统PID）

如果想对比前馈效果，可以将前馈增益设为0：

```c
M2006_SetFeedforward(&motors[0], 0.0f, 0.0f);  // 禁用所有前馈
```

---

## 🛠️ 参数调试指南

### 推荐调试步骤：

#### Step 1：先禁用前馈，调好基础PID参数
```c
M2006_SetFeedforward(&motors[0], 0.0f, 0.0f);
// 调整 Kp, Ki, Kd，使系统稳定但响应可能较慢
```

#### Step 2：启用速度前馈，逐步增大Kff
```c
// 从较小的值开始
M2006_SetFeedforward(&motors[0], 0.5f, 0.0f);
// 逐步增大：0.5 → 0.8 → 1.0 → 1.5 → 2.0
// 观察响应速度和稳态误差
```

**判断标准**：
- ✅ 理想状态：启动快速，稳态误差小（<10 RPM），无明显超调
- ❌ Kff过小：启动慢，稳态误差大
- ❌ Kff过大：稳态时电流偏大，可能轻微超调

#### Step 3：启用加速度前馈，微调Kaff
```c
// 速度前馈调好后，加入小量加速度前馈
M2006_SetFeedforward(&motors[0], 1.0f, 0.05f);
// 逐步增大：0.05 → 0.1 → 0.15 → 0.2
```

**判断标准**：
- ✅ 理想状态：快速变速时跟踪更准确，启动更平滑
- ❌ Kaff过小：变速时仍有延迟
- ❌ Kaff过大：启动时有冲击感，可能引起振荡

---

## 📊 效果对比

| 控制方式 | 响应时间 | 稳态误差 | 超调量 | 适用场景 |
|---------|---------|---------|--------|---------|
| **仅PID** | 慢 | 较大 | 小 | 精度要求不高的场景 |
| **PID + 速度前馈** | 快 | 小 | 中等 | **推荐**，通用场景 |
| **PID + 双前馈** | 极快 | 极小 | 中等 | 高动态性能要求 |

---

## 🔍 调试工具

项目中已集成 **SEGGER RTT** 实时日志输出，可以监控关键参数：

```c
// 在主循环中已有的调试输出（每10ms打印一次）
SEGGER_RTT_printf(0,
    "[%05lu] Target:%4d | Actual:%5d | Error:%6d | PID_Out:%7d | I-Term:%9d\n",
    loop_counter,
    motors[0].target_speed,
    motors[0].feedback.speed_filtered,
    motors[0].pid.last_error,
    motors[0].pid.output,
    motors[0].pid.integral
);
```

**观察重点**：
1. **Error（误差）**：应快速收敛到小值
2. **PID_Out（输出）**：不应频繁饱和（±10000）
3. **I-Term（积分项）**：不应过大

---

## ⚠️ 注意事项

### 1. 前馈增益与负载相关
- 不同负载下，最佳前馈参数可能不同
- 建议在实际工况下调试参数

### 2. 前馈不能替代PID
- 前馈是开环控制，无法消除干扰和模型误差
- 必须保留PID反馈控制

### 3. 控制周期要准确
- 加速度前馈依赖于准确的dt（控制周期）
- 当前设置为 **1ms**（在 `m2006_motor.c` 中定义）
- 如果修改主循环周期，需同步修改 `M2006_CONTROL_PERIOD_S`

### 4. 避免前馈增益过大
- 过大的前馈可能导致饱和，反而降低性能
- 建议分步调试，逐步增大

---

## 🧪 测试建议

### 测试1：阶跃响应测试
```c
M2006_SetTarget(&motors[0], 0);      // 初始静止
HAL_Delay(2000);
M2006_SetTarget(&motors[0], 3000);   // 突然给定3000 RPM
// 观察上升时间、超调量、稳态误差
```

### 测试2：正弦跟踪测试
```c
// 周期性改变目标速度
float target = 2000.0f * sinf(2.0f * 3.14159f * t / 5.0f);  // 5秒周期
M2006_SetTarget(&motors[0], target);
// 观察跟踪误差
```

### 测试3：负载扰动测试
```c
M2006_SetTarget(&motors[0], 2000);   // 给定恒定转速
// 手动给电机施加负载
// 观察速度是否能快速恢复
```

---

## 📚 理论补充

### 为什么前馈有效？

以电机系统为例，动力学方程为：
```
J·dω/dt + B·ω + Tload = Kt·I
```

其中：
- J：转动惯量
- B：粘性摩擦系数
- Tload：负载力矩
- Kt：力矩常数
- I：电流（控制输入）

**速度前馈 Kff·ω**：补偿稳态项 `B·ω + Tload`  
**加速度前馈 Kaff·dω/dt**：补偿惯性项 `J·dω/dt`

这样PID控制器只需要处理剩余的误差和干扰，大大减轻了负担。

---

## 📞 问题排查

| 现象 | 可能原因 | 解决方案 |
|-----|---------|---------|
| 电机不转 | 前馈过小或PID参数不对 | 检查PID参数，增大Kff |
| 启动冲击大 | Kaff过大 | 减小Kaff或设为0 |
| 稳态误差大 | Kff过小 | 逐步增大Kff |
| 持续振荡 | Kff或Kaff过大 | 减小前馈增益，检查PID的Kd |
| 输出饱和 | 前馈+PID总输出过大 | 减小前馈增益或PID增益 |

---

## ✅ 快速开始

**最简单的使用方式（使用默认参数）：**

```c
// main.c
M2006_InitAll(motors, &hcan1);           // 自动设置 Kff=0.8, Kaff=0.1
M2006_SetTarget(&motors[0], 3000);       // 设置目标转速
M2006_UpdateAll(motors, 2);               // 在主循环中更新（1ms周期）
```

**就这么简单！前馈已经生效了！** 🎉

---

## 📖 相关文件

- `Core/modules/pid/2006pid.h` - PID结构体定义（含前馈参数）
- `Core/modules/pid/2006pid.c` - PID计算实现（含前馈逻辑）
- `Core/modules/motor/m2006motor/m2006_motor.h` - M2006电机接口
- `Core/modules/motor/m2006motor/m2006_motor.c` - M2006电机实现（前馈默认参数）

---

## 🚀 版本历史

- **v1.0** (2025-01-XX)
  - 初始版本
  - 添加速度前馈（Kff）
  - 添加加速度前馈（Kaff）
  - 默认参数：Kff=0.8, Kaff=0.1

---

**祝你调试顺利！如有问题，请检查SEGGER RTT输出的调试信息。** 😊